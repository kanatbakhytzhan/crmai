# Проверка команд mute (/stop, /start, /stop all, /start all)

Команды работают в **WhatsApp** (Cloud API webhook) и **ChatFlow** (POST /api/chatflow/webhook). Регистр не важен, лишние пробелы схлопываются.

## Логика

- **/stop** — отключить автоответ только в **этом чате** (по external_id = номер отправителя / remoteJid). Лиды и сообщения продолжают сохраняться; ответ AI не отправляется.
- **/start** — снова включить автоответ в этом чате. Контекст (история) не теряется — после /start бот помнит диалог.
- **/stop all** — отключить автоответ для **всех чатов** этого бизнес-номера (phone_number_id). Один mute на весь номер.
- **/start all** — включить автоответ для всех чатов этого номера.

Приоритет: сначала проверяется **scope=all** (mute на весь номер), затем **scope=chat** (mute на один чат). Плюс глобальный **tenant.ai_enabled** — если false, AI не отвечает никому.

## Как проверить в реальном WhatsApp

1. **Включите webhook и отправку:** `WHATSAPP_ENABLED=true`, `WHATSAPP_SEND_ENABLED=true` (и при необходимости ChatFlow токены). Убедитесь, что бот отвечает на обычное сообщение.

2. **Отключить только этот чат:**  
   Отправьте в чат с ботом: `stop` или `/stop`.  
   Ожидание: ответ «Ок. Я отключил автоответ в этом чате. Лиды будут сохраняться.»  
   Затем отправьте любое другое сообщение (например «Привет»).  
   Ожидание: ответа от AI нет, но в БД создаётся лид и сообщение попадает в `conversation_messages`.

3. **Включить снова этот чат:**  
   Отправьте: `start` или `/start`.  
   Ожидание: ответ «Ок. Автоответ в этом чате снова включён.»  
   Отправьте ещё одно сообщение — бот должен ответить и **помнить контекст** (предыдущие реплики).

4. **Отключить все чаты номера:**  
   Отправьте: `stop all` или `/stop all`.  
   Ожидание: ответ «Ок. Я отключил автоответ для всех чатов этого номера.»  
   Проверьте с другого номера (если есть): ответа тоже не должно быть.

5. **Включить все чаты:**  
   Отправьте: `start all` или `/start all`.  
   Ожидание: ответ «Ок. Автоответ для всех чатов снова включён.»  
   И этот чат, и другие снова получают ответы.

## Логи

В логах сервера при выполнении команд и при проверке mute:

- `[MUTE] chat set muted=true channel=... phone_number_id=... external_id=...`
- `[MUTE] all set muted=true channel=... phone_number_id=...`
- `[MUTE] is_muted=true scope=all|chat ...` — когда входящее не получило ответ из-за mute

Голосовые: если голосовое сообщение транскрибируется в текст и текст совпадает с командой (/stop, /start и т.д.), команда выполняется по этому тексту.
